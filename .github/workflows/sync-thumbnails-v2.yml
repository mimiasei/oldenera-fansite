name: ğŸ–¼ï¸ Sync Generated Thumbnails

on:
  repository_dispatch:
    types: [sync-thumbnails]
  workflow_dispatch: # Allow manual triggering

jobs:
  sync-thumbnails:
    name: Download and Deploy Thumbnails
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“Š Get Sync Status
        id: get_response
        run: |
          echo "Checking sync status..."
          RESPONSE=$(curl -s "https://oldenera-fansite.onrender.com/api/thumbnailsync/status")
          echo "API Response received"
          # Store JSON response using proper multiline format for GitHub Actions
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ“Š Parse Status Response  
        id: status
        run: |
          PENDING_COUNT=${{ fromJson(steps.get_response.outputs.response).totalPending }}
          PENDING_THUMBNAILS=${{ fromJson(steps.get_response.outputs.response).pendingThumbnails }}
          PENDING_LARGE=${{ fromJson(steps.get_response.outputs.response).pendingLarge }}
          
          echo "Parsed values: total=$PENDING_COUNT, thumbnails=$PENDING_THUMBNAILS, large=$PENDING_LARGE"
          
          echo "pending_count=$PENDING_COUNT" >> $GITHUB_OUTPUT
          echo "pending_thumbnails=$PENDING_THUMBNAILS" >> $GITHUB_OUTPUT
          echo "pending_large=$PENDING_LARGE" >> $GITHUB_OUTPUT
          
          if [ "$PENDING_COUNT" = "0" ]; then
            echo "No pending thumbnails found"
            echo "has_pending=false" >> $GITHUB_OUTPUT
          else
            echo "Found $PENDING_COUNT pending thumbnails ($PENDING_THUMBNAILS thumbnails + $PENDING_LARGE large)"
            echo "has_pending=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ Download Pending Thumbnails
        if: steps.status.outputs.has_pending == 'true'
        run: |
          echo "Downloading pending thumbnails..."
          
          # Download with better error handling
          if ! curl -L --fail "https://oldenera-fansite.onrender.com/api/thumbnailsync/download-pending" --output thumbnails.zip; then
            echo "âŒ Failed to download thumbnails"
            exit 1
          fi
          
          # Verify zip file
          if [ ! -f thumbnails.zip ] || [ ! -s thumbnails.zip ]; then
            echo "âŒ Downloaded file is empty or missing"
            exit 1
          fi
          
          echo "Downloaded $(du -h thumbnails.zip | cut -f1) zip file"
          
          # Extract to frontend directory structure
          mkdir -p frontend/public/images/screenshots/thumbnails
          mkdir -p frontend/public/images/screenshots/large
          
          # Extract with error handling
          if ! unzip -j thumbnails.zip "thumbnails/*" -d frontend/public/images/screenshots/thumbnails/ 2>/dev/null; then
            echo "âš ï¸ No thumbnails/ directory in zip or extraction failed"
          fi
          
          if ! unzip -j thumbnails.zip "large/*" -d frontend/public/images/screenshots/large/ 2>/dev/null; then
            echo "âš ï¸ No large/ directory in zip or extraction failed"
          fi
          
          rm thumbnails.zip
          
          # Count extracted files
          THUMB_COUNT=$(find frontend/public/images/screenshots/thumbnails/ -name "*.webp" -o -name "*.jpg" 2>/dev/null | wc -l)
          LARGE_COUNT=$(find frontend/public/images/screenshots/large/ -name "*.webp" -o -name "*.jpg" 2>/dev/null | wc -l)
          TOTAL_COUNT=$((THUMB_COUNT + LARGE_COUNT))
          
          echo "Extracted $TOTAL_COUNT files ($THUMB_COUNT thumbnails, $LARGE_COUNT large)"
          echo "extracted_count=$TOTAL_COUNT" >> $GITHUB_ENV

      - name: ğŸ“ Commit and Push Changes
        if: steps.status.outputs.has_pending == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions"
          
          # Add all new thumbnail files
          git add frontend/public/images/screenshots/thumbnails/ 2>/dev/null || true
          git add frontend/public/images/screenshots/large/ 2>/dev/null || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            COMMIT_COUNT="${{ env.extracted_count }}"
            [ -z "$COMMIT_COUNT" ] && COMMIT_COUNT="unknown"
            
            git commit -m "ğŸ–¼ï¸ Auto-sync $COMMIT_COUNT generated thumbnails
            - WebP and JPEG thumbnails for optimized loading
            - Generated via backend image processing  
            - Batch sync from temporary storage"
            
            git push
            echo "âœ… Changes committed and pushed successfully"
          fi

      - name: ğŸ§¹ Mark Thumbnails as Synced
        if: steps.status.outputs.has_pending == 'true'
        run: |
          echo "Marking thumbnails as synced on backend..."
          RESPONSE=$(curl -s -X POST "https://oldenera-fansite.onrender.com/api/thumbnailsync/mark-synced")
          echo "Backend cleanup response: $RESPONSE"
          
      - name: ğŸ“Š Summary
        run: |
          if [ "${{ steps.status.outputs.has_pending }}" = "true" ]; then
            EXTRACTED_COUNT="${{ env.extracted_count }}"
            [ -z "$EXTRACTED_COUNT" ] && EXTRACTED_COUNT="some"
            echo "âœ… Successfully synced $EXTRACTED_COUNT thumbnails"
            echo "ğŸš€ Thumbnails now available via Vercel CDN"
          else
            echo "â„¹ï¸ No pending thumbnails found - nothing to sync"
          fi
